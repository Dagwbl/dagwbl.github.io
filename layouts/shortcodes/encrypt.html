{{ $hint := .Get "hint" | default "请输入密码" }}
<div class="encrypted-content" data-cipher="{{ .Inner | base64Encode | replaceRE "(.{5})(.{3})(.{4})(.+)" "$2$4$1$3" }}" data-hint="{{ .Get "hint" }}">
    <p>🔒 此处内容已加密</p>
    <div class="password-prompt">
      <input type="password" 
             class="password-input"
             placeholder="{{ .Get "hint" | default "请输入密码" }}" 
             id="pwd-input-{{ .Ordinal }}"
             aria-label="加密内容密码">
      <button class="decrypt-btn" onclick="decryptContent(event, 'pwd-input-{{ .Ordinal }}')">解锁</button>
    </div>
    <div class="status-message"></div>
    <div class="encrypted-text" hidden></div>
</div>
  
<style>
.encrypted-content {
  border: 1px solid var(--border-color, #878787);
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin: 1.5rem 0;
  transition: box-shadow 0.3s;
  background-color: var(--entry, #fff);
}
  
.encrypted-content:focus-within {
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
}
  
.password-prompt {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}
  
.password-input {
  flex: 3;
  min-width: 200px;
  padding: 0.75rem;
  border: 1px solid var(--border-color, #eee);
  border-radius: 0.25rem;
  transition: border-color 0.3s;
  background-color: var(--theme);
  color: var(--primary);
}
  
.password-input:focus {
  border-color: var(--primary, #1e90ff);
  outline: none;
}
  
.password-input.error {
  border-color: var(--error-color, #dc3545);
}
  
.decrypt-btn {
  padding: 0.75rem 1.25rem;
  background-color: var(--primary, #1e90ff);
  color: var(--theme);
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
  transition: opacity 0.3s;
  font-weight: 500;
  flex: 1;
}
  
.decrypt-btn:hover {
  opacity: 0.9;
}
  
.encrypted-text {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px dashed var(--border-color, #eee);
  color: var(--content);
}
  
.status-message {
  color: var(--secondary, #6c757d);
  margin-top: 0.5rem;
  font-size: 0.9em;
  min-height: 1.2em;
}
  
.status-message.error {
  color: var(--error-color, #dc3545);
}
  
[hidden] {
  display: none !important;
}
</style>
  
<script>
function decryptContent(event, inputId) {
  event.preventDefault();
  const input = document.getElementById(inputId);
  if (!input) return;

  const container = input.closest('.encrypted-content');
  const statusEl = container.querySelector('.status-message');
  statusEl.textContent = '';
  statusEl.classList.remove('error');
  input.classList.remove('error');

  // 基于UTC时间的密码生成（避免时区问题）
  const d = new Date();
  const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
  const dd = String(d.getUTCDate()).padStart(2, '0');
  const todayCode = parseInt(mm + dd);
  const validCode = String(1005 - todayCode).padStart(4, '0');

  if (input.value !== validCode) {
    input.classList.add('error');
    statusEl.textContent = `密码错误，今日有效密码为：${validCode}`;
    statusEl.classList.add('error');
    input.focus();
    return;
  }

  try {
    // 从混淆的Base64恢复原始字符串并解码
    let cipherText = container.dataset.cipher
      .replace(/\s+/g, '')
      .replace(/-/g, '+')
      .replace(/_/g, '/');
    
    // 反混淆处理 - 将之前移动的字符块还原
    // 例如: 如果我们用 $2$4$1$3 混淆，这里需要还原回 $1$2$3$4
    const len = cipherText.length;
    if (len > 12) {
      // 提取各个部分 (这里的索引需要与混淆时使用的模式对应)
      const part1 = cipherText.substring(0, 3);  // 原始的第2部分
      const part2 = cipherText.substring(3, len-9); // 原始的第4部分
      const part3 = cipherText.substring(len-9, len-4); // 原始的第1部分
      const part4 = cipherText.substring(len-4); // 原始的第3部分
      
      // 重新组合
      cipherText = part3 + part1 + part4 + part2;
    }

    const decodedStr = atob(cipherText);
    const decrypted = new TextDecoder().decode(
      Uint8Array.from(decodedStr, c => c.charCodeAt(0))
    );

    container.querySelector('.encrypted-text').innerHTML = decrypted;
    container.querySelector('.password-prompt').hidden = true;
    statusEl.hidden = true;
    container.querySelector('.encrypted-text').hidden = false;
  } catch (e) {
    console.error('Decryption failed:', e);
    statusEl.textContent = `解码失败: ${e.message}`;
    statusEl.classList.add('error');
  }
}

// 添加键盘事件支持
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.password-input').forEach(input => {
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        decryptContent(e, e.target.id);
      }
    });
  });
});
</script>